# Use Node.js image
FROM node:20-alpine

# Install PostgreSQL client (required for Prisma/DB tools)
RUN apk add --no-cache postgresql-client icu-libs

WORKDIR /app

# Copy package files and tsconfig first
COPY backend/package*.json backend/tsconfig.json ./

# Install ALL dependencies including devDependencies (needed for TypeScript compiler)
RUN npm ci || true

# Copy source code (includes types.ts)
COPY backend/src ./src
COPY gcs_db_backup.sql ./

# Build TypeScript
RUN npx tsc

# Copy and make entrypoint executable
COPY backend/entrypoint.sh ./
RUN chmod +x entrypoint.sh

# Expose the port
EXPOSE 8080

# Set the entrypoint
CMD ["sh", "entrypoint.sh"]